{
  "hash": "1667d53f7f06f0aaedfa57b3b6d47f9e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Réaliser des cartes thématiques avec Mapsf\"\n\ncategories:\n  - Cartographie\n  \nauthor: \n  - name: \"Coralie Cottet\"\n    affiliations:\n      - name: \"Ensai-Ined\"\n\ndate: 07/27/2023\n\nimage: \"logo.png\"\n\nformat: \n  html: default\n\nfilters:\n  - lightbox\nlightbox: auto\n\nabstract: |\n Nous allons montrer comment réaliser des cartes avec R à l'aide du package **`mapsf`** (T.Giraud) et du packages **`sf`**. mapsf est un outil très utile pour manipuler et visualiser des données spatiales en R, tandis que le package \"sf\" fournit une infrastructure pour stocker et manipuler ce type de données. Ces deux packages offrent une solution simple et pratique pour réaliser ce type d'analyse. \n\n---\n\n\n![](logo.png){width=10%}\n\n**Documentation** (Timothé Giraud):  \n\n*  <https://rcarto.github.io/ined2022/07_mise_en_page.html>\n\n* <http://riatelab.github.io/mapsf>\n\n* <http://rgeomatic.hypotheses.org/2077>\n\n\n\n**Installation des packages**: \n\n```markdown\ninstall.packages(mapsf)\ninstall.packages(sf)\ninstall.packages(dplyr)\n```\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(mapsf)\nlibrary(sf)\nlibrary(dplyr)\n```\n:::\n\n\n\nNous allons réaliser une carte de Paris avec les données du site de Paris Data [[Lien](http://opendata.paris.fr/pages/catalogue/?disjunctive.theme&disjunctive.publisher)]\n\n\n# Importation des données\n\nIl existe plusieurs formats de fond de carte:\n\n* **GeoJSON** est un format de données géospatiales basé sur JSON (JavaScript Object Notation) qui permet de stocker des données géographiques sous forme de caractères.\n\n* **Shapefile** est un format de données géospatiales propriétaire développé par *Esri* (Environmental Systems Research Institute). Il est constitué de plusieurs fichiers qui stockent des informations sur les entités géographiques telles que les points, les lignes et les polygones, ainsi que des attributs associés à ces entités. \n\n\nIci le fond importé est en format *GeoJSON*, il correspond aux limites des arrondissements.  On va lui ajouter celui des voies d'eau en couche d'habillage.\n\n\n\n::: {.cell filename='Importation des données' result='false'}\n\n```{.r .cell-code}\narrondissements <- st_read(dsn = \"https://opendata.paris.fr/explore/dataset/arrondissements/download/?format=geojson&timezone=Europe/Berlin&lang=fr\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `OGRGeoJSON' from data source \n  `https://opendata.paris.fr/explore/dataset/arrondissements/download/?format=geojson&timezone=Europe/Berlin&lang=fr' \n  using driver `GeoJSON'\nSimple feature collection with 20 features and 9 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 2.224078 ymin: 48.81558 xmax: 2.469761 ymax: 48.90216\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\ncours_deau<-st_read(dsn=\"https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/plan-de-voirie-voies-deau/exports/geojson?lang=fr&timezone=Europe%2FBerlin\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `OGRGeoJSON' from data source \n  `https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/plan-de-voirie-voies-deau/exports/geojson?lang=fr&timezone=Europe%2FBerlin' \n  using driver `GeoJSON'\nSimple feature collection with 58 features and 25 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 2.224081 ymin: 48.81924 xmax: 2.450555 ymax: 48.90207\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n:::\n\n::: {.cell filename='Affichage du fond de carte des arrondissements avec cours d\\'eau'}\n\n```{.r .cell-code}\n# Arrondissements\nmf_map(x = arrondissements, border = \"black\") \n\n# Ajout des cours d'eau\nmf_map(x=cours_deau,lwd=2,border=\"lightblue\",col=\"lightblue\",add=TRUE)\n```\n\n::: {.cell-output-display}\n![](map_sf_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n::: {.cell filename='Fond noir'}\n\n```{.r .cell-code}\nmf_theme(\"darkula\")\n```\n:::\n\n\n\n# Différents types de cartes\n\n\n![](arbre_type_data.png)\n\n## Les cartes à symboles proportionnels\n\nLa  carte en symboles proportionnels est la méthode de représentation graphique à utiliser pour visualiser des variables de stocks (variables quantitatives absolues pour lesquelles la somme et la moyenne ont une signification).\n\nSur la carte, on affiche l'effectif de la population de chaque arrondissement et on ajoute la légende et un titre.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Ajout manuel des valeurs des populations de chaque arrondissements dans le tableau sous le nom \"pop\"\narrondissements$pop <- c(1012687, 903036, 1369857, 1491027, 1672009, 1506475, 1637163, 1603380, 1637542, 1059282, 1494945, 1436205, 1705774, 1425805, 236769, 1668605, 1674568, 1539668, 1421827, 1829526) #INSEE,2021. La valeur 1012687 correspond à la population dans le 1er arrondissement.\n```\n:::\n\n\n\n* Pour représenter la carte, on utilise la fonction `map_sf()`. On doit indiquer à minima la variable liée à la statistique (`var=pop`), et le type de carte (`type=prop`). \n* On va superposer 2 cartes: le fond affichant seulement les limites des arrondissements, et celle affichant sous forme de bulle proportionnelles la taille de la population dans chaque arrondissement.\n\n\n\n::: {.cell filename='Carte avec la fonction mf_map()'}\n\n```{.r .cell-code}\nmf_map(x = arrondissements)\nmf_map(\n  x = arrondissements,\n  var = \"pop\" ,\n  type = \"prop\",  \n  leg_title = \"Population totale\\12 271 794\",\n  col=\"#C24168\",\n  add= TRUE,\n  inches=0.2)\n\nmf_title(\"Distribution de la population dans les arrondissements de Paris\")\n```\n\n::: {.cell-output-display}\n![](map_sf_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n## Les cartes choroplèthes\n\nLa *carte choroplèthe* est la représentation  à utiliser pour visualiser des ratios (variables quantitatives relatives pour lesquelles la moyenne a un sens, mais dont la somme n'en a pas), et qui sont des variables ordinales.\n\nSur la carte, on affiche la densité de population de chaque arrondissement. On utilise ici la méthode des quantiles pour discrétiser cette variable, et on applique une palette de couleurs séquentielles avec dégradé pour représenter l'ordre entre les valeurs.\n\n\n::: {.cell filename='Variable densité de la population'}\n\n```{.r .cell-code}\n#création de la variable densite \narrondissements$DENS <- 1e6 * arrondissements$pop / as.numeric(st_area(arrondissements))\n```\n:::\n\n::: {.cell filename='Carte avec la fonction mf_map()'}\n\n```{.r .cell-code}\nmf_map(\n  x = arrondissements,\n# variable à représenter: densité de population  \nvar = \"DENS\",\n# type de carte  \ntype = \"choro\",\n# méthode de dsicrétisation\n  breaks = \"quantile\",\n# palette de rouges  \npal = \"Reds\",\n  lwd = 1,\n  leg_title = \"Densité de population\\n(habitants par km2)\", \n  leg_val_rnd = 0\n)\n```\n\n::: {.cell-output-display}\n![](map_sf_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n::: callout-note \nla faible densité de population des 12e et 16e arrondissement résulte notamment des zônes *bois de Vincennes* et de *Bois de Boulogne* qui les composent.\n:::\n\n\n## Les cartes pour une variable qualitative nominale\n\nOn peut aussi représenter un autre type de variable: qualitative nominale. Pour illuster cette fiche on va représenter les bords politiques des mairies de chaque arrondissement.\nPour cela, on produit une carte choroplèthes mais avec des couleurs *sans dégradé* (palettee qualitative).  \n\n* Penser à trier la base par numéro d'arrondissement avant de fusionner les informations sur les bords politiques (`arrange()`)\n* Bien vérifier que les couleurs, ici fortement informatives, correspondent bien aux bords politiques. Sans raison apparente, il a été ici nécessaire de les renseigner dans l'ordre EELV, LR et PS. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\narrondissements2 = select(arrondissements, c_ar, l_aroff, geom_x_y, geometry)\narrondissements2 = arrange(arrondissements2, c_ar)\n\nbords_politiques <- c(\"LR\", \"EELV\", \"PS\", \"PS\", \"LR\", \"LR\", \"LR\", \"LR\", \"LR\", \"PS\", \"PS\", \"PS\", \"PS\", \"PS\", \"LR\", \"LR\", \"LR\", \"PS\", \"PS\", \"PS\")\n# Le maire du 2e arrondissement de Paris était EELV entre 2014 et 2015.\n\n\narrondissements2 <- cbind(arrondissements2, bords_politiques)\n\n# Choix des couleurs\n\ncolors <- c(\"EELV\" = \"#31a354\", \"LR\" = \"#3182bd\", \"PS\" = \"#C24168\")\n\n# Placer les carrés sur les centroïdes des polygones des arrondissements.\narr_c<-st_centroid(arrondissements2)\n\n\n\nmf_map(x = arrondissements2, border = \"black\")\n\n# Choix  du symbol rectangle (pch=15)\nmf_map(\n  x = arr_c,\n  var = \"bords_politiques\",\n  pal=colors,\n  type=\"symb\",\n  pch=15,\n  cex = 2,\n  lwd = .5,\n  leg_title = \"\",\n  border=\"black\"\n)\n\n\n# habillage additionnel\nmf_layout(\n  title = \"Bord politique des maires de Paris entre 2014 et 2020\",\n  credits = paste0(\n    \"mapsf \",\n    packageVersion(\"mapsf\")\n  )\n)\n```\n\n::: {.cell-output-display}\n![](map_sf_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\nIl est courant de représenter les cartes électorales en remplissant les aires géographiques par des couleurs. Par rapport \nau graphique précédent, il suffit d'utiliser `type=\"typo\"` et de retirer l'argument `pch`. On ajoute également le numéro de l'arrondissement avec la fonction `mf_label`.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\nmf_map(\n  x = arrondissements2,\n  # var à représenter  \n  var = \"bords_politiques\",\n  pal=colors,\n  type=\"typo\",\n  cex = 2,\n  lwd = .5,\n  leg_title = \"\",\n  leg_pos= c(2.43, 48.91396),\n  border=\"black\"\n)\n\nmf_layout(\n  title = \"Bord politique des maires de Paris entre 2014 et 2020\",\n  credits = paste0(\n    \"mapsf \",\n    packageVersion(\"mapsf\")\n  )\n)\n\nmf_label(\n  x = arrondissements2, var = \"c_ar\", col = \"grey\", halo = TRUE, overlap = FALSE, lines = FALSE,\n)\n```\n\n::: {.cell-output-display}\n![](map_sf_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n# Pour aller plus loin: regroupement de polygones  \n\n**Exemple 1: fusion des arrondissements 15 et 16 avec aggrégation de la population**\n\nL'objectif est de fusionner les données de deux arrondissements (le 15ème et le 16ème) en un seul arrondissement sur le fond de carte, et d'agréger leur population.\n\nLes étapes sont :\n\n* Sélection des polygones géométriques des 15ème (Vaugirard) et 16ème (Passy) arrondissements dans le dataset des arrondissements.\n\n* Fusionner ces deux polygones en un seul avec la fonction st_union(). On obtient un nouveau polygone contenant la géométrie unifiée.\n\n* Aggreger les valeurs de leur population pour le nouveau polygone.\n\n* Renommer les informations d'identification du nouveau secteur  (ici son nom).\n\n* Créer un nouveau dataset avec ces informations pour le nouveau secteur.\n\n* Remplacer dans le dataset original les informations des deux arrondissements par celles du nouveau secteur.\n\n\nOn obtient ainsi un nouveau dataset des arrondissements dans lequel les 15ème et 16ème ont été fusionnés . Ce nouveau secteur fusionné peut alors être représenté sur le fond de carte.    \n\n\n\n::: {.cell filename='Récupération des informations nécessaires'}\n\n```{.r .cell-code}\narrondissements2 = select(arrondissements, c_ar, l_aroff, geom_x_y, pop)\narrondissements2 = arrange(arrondissements2, c_ar)\n```\n:::\n\n::: {.cell filename='Sélection des deux polygones à fusionner'}\n\n```{.r .cell-code}\npoly1 = arrondissements2[arrondissements2$c_ar == 15, ]\npoly2 = arrondissements2[arrondissements2$c_ar == 16, ] \n```\n:::\n\n::: {.cell filename='Fusion des deux polygones'}\n\n```{.r .cell-code}\nnew_poly = st_union(poly1, poly2) \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: attribute variables are assumed to be spatially constant throughout\nall geometries\n```\n\n\n:::\n:::\n\n::: {.cell filename='Agregation des deux populations'}\n\n```{.r .cell-code}\nnew_poly$pop = new_poly$pop+ new_poly$pop.1\n```\n:::\n\n::: {.cell filename='Changement du nom de la zône'}\n\n```{.r .cell-code}\nnew_poly$l_aroff = \"Fusion 15 et 16\"\n```\n:::\n\n::: {.cell filename='Insertion de la fusion dans la base arrondissements'}\n\n```{.r .cell-code}\n# Il est très important de mettre les éléments dans le même ordre que celui du tableau\narrondissements_fus <- subset(new_poly, select = c(c_ar, l_aroff, geom_x_y, pop))\n\n# On supprime les lignes des deux arrondissements fusionner\narrondissements2 = filter(arrondissements2, c_ar<15 | c_ar>16)\n\n# On insère la ligne des arrondissements fusionnés dans la base arrondissement\narrondissements2 = rbind(arrondissements2, arrondissements_fus)\n```\n:::\n\n::: {.cell filename='Exécution de la carte'}\n\n```{.r .cell-code}\nmf_map(x = arrondissements2,border= \"black\")\nmf_map(x = arrondissements2,\n       # variable à représenter: population des arrondissements\n       var = \"pop\",\n       # type de carte : symboles proportionnels\n       type = \"prop\",\n       leg_title = \"Population des arrondissements\",\n       col=\"#C24168\",\n       add= TRUE,\n       inches=0.2)\n```\n\n::: {.cell-output-display}\n![](map_sf_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n\n**Exemple 2: fusion des 4 premiers arrondissements aux élections de 2020**\n\n\nPour les élections municipales de 2020, les 4 premiers arrondissements de la ville ont été fusionnés. Cette zône a été appelée **Centre**, et le choix de la localisation de mairie s'est porté sur le 3ème arrondissement.   \n\n\nLe code ci-dessous procède à la fusion de ces 4 arrondissements\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\narrondissements <- st_read(dsn = \"https://opendata.paris.fr/explore/dataset/arrondissements/download/?format=geojson&timezone=Europe/Berlin&lang=fr\")\narrondissements <- subset(arrondissements, select = c(c_ar, l_aroff,geometry))\n\n\npoly1 = arrondissements[arrondissements$c_ar == \"1\", ] \npoly2 = arrondissements[arrondissements$c_ar == \"2\", ]\npoly3 = arrondissements[arrondissements$c_ar == \"3\", ]\npoly4 = arrondissements[arrondissements$c_ar == \"4\", ]\n\npoly12   = st_union(poly1, poly2) \npoly34   = st_union(poly3,poly4)\nnew_poly = st_union(poly12,poly34)\n\nnew_poly$l_aroff = \"Centre\" # changer le nom de l'arrondissement\nnew_poly$c_ar    =  \"3\"     # changer le code de l'arrondissement\n\n# Il est très important de mettre les éléments dans le même ordre que celui du tableau\narrondissements_fus = subset(new_poly, select = c(c_ar, l_aroff,geometry))\n\narrondissements = filter(arrondissements, c_ar>4)\narrondissements = rbind(arrondissements, arrondissements_fus)\n\nmf_map(x = arrondissements,border= \"black\")\n```\n\n::: {.cell-output-display}\n![](map_sf_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\nbords_politiques = c(\"Gauche\",\"Droite\",\"Droite\",\"Droite\",\"Droite\",\"Droite\",\"Gauche\",\"Gauche\",\"Ecolo\",\"Gauche\",\"Gauche\",\"Droite\",\"Droite\",\"Droite\",\"Gauche\",\"Gauche\",\"Gauche\")\ncolors <- c( \"Droite\" = \"#3182bd\", \"Ecolo\" = \"#31a354\",  \"Gauche\" = \"#C24168\")\n\n\n# c_ar est passé en string => repasser en numérique pour arrange\narrondissements$c_ar = as.numeric(arrondissements$c_ar)\narrondissements = arrange(arrondissements, c_ar)\narrondissements = cbind(arrondissements, bords_politiques)\n\n# label: on change la valeur 3 par centre pour la zône fusionnée\narrondissements$c_ar2 = as.character(arrondissements$c_ar)\narrondissements$c_ar2[arrondissements$c_ar2 == \"3\"]  = \"Centre\"\n```\n:::\n\n\nCarte électorale à l'issue des élections de 2020\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\nmf_map(\n  x = arrondissements,\n  var = \"bords_politiques\",\n  pal=colors,\n  type=\"typo\",\n  cex = 2,\n  lwd = .5,\n  leg_title = \"\",\n  leg_pos= c(2.43, 48.91396),\n  border=\"black\"\n)\n\nmf_layout(\n  title = \"Bord politique des maires de Paris aux élections de 2020\",\n  credits = paste0(\n    \"mapsf \",\n    packageVersion(\"mapsf\")\n  )\n)\n\nmf_label(\n  x = arrondissements, var = \"c_ar2\", col = \"grey\", halo = TRUE, overlap = FALSE, lines = FALSE,\n)\n```\n\n::: {.cell-output-display}\n![](map_sf_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "map_sf_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}